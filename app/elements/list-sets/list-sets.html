<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">
<!-- Iron elements -->
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/iron-data-table/iron-data-table.html">
<link rel="import" href="../../bower_components/iron-image/iron-image.html">

<!-- Paper elements -->
<link rel="import" href="../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../bower_components/paper-styles/typography.html">

<link rel="import" href="list-of-sets.html">

<dom-module id="list-sets">
  <template>
    <style include="shared-styles">
      :host {
        display: block;
      }
    </style>
    <iron-ajax
      id="theAjax"
      url="https://rebrickable.com/api/get_user_setlists"
      params="{{_params}}"
      handle-as="json"
      on-response="_handleResponse">
    </iron-ajax>


    <paper-material elevation="1">
      <list-of-sets set-list-id="{{setListId}}" user-hash="{{userHash}}"></list-of-sets>
    </paper-material>
  </template>
  <script>
  (function() {
    'use strict';

    Polymer({
      is: 'list-sets',

      properties: {
        userHash: {
          type: String,
          value: '',
          observer: '_onHashChanged',

        },

        _params: {
          type: String,
          value: ''
        },

        showing: {
          type: Boolean,
          value: false,
          observer: '_onShowingChanged'
        },

        tabsToShow:{
          type: Object,
          value: {},
          notify: true,
        },

        setListId: {
          type: Number,
          value: -1,
          notify: true,
        },


        _data: [],
      },

      _onHashChanged: function() {
        this._data = [];
        if(this.userHash && this.setListId)
        this._params = {
          key: 'p4GLMlcPxJ',
          hash: this.userHash,
          format: 'json'
        };
      },

      _handleResponse: function(response) {
        if (response.detail.response) {
          this._data = response.detail.response.sets;
          if (this._data.length > 0 && this.setListId < 0) {
            this.setListId = this._data[0].setlist_id;
          }

          if (this.showing) {
            var tabsToShow = {
              selected: this.setListId,
              route: 'sets',
              tabs: []
            };

            this._data.forEach(function(element) {
              tabsToShow.tabs.push({
                id: element.setlist_id,
                title: element.name,
              });
            }.bind(this));
            this.set('tabsToShow', tabsToShow);
            this.saveTabsToShow = tabsToShow;
          }
        }
      },

      _onShowingChanged: function() {
        this.$.theAjax.auto = this.showing;
      },

    });
  })();
  </script>
</dom-module>
